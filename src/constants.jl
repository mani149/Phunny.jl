"""
	Defining physical constants and data structures 
"""


#-----------------#
# Data structures #
#-----------------#

struct Bond{T}
    i::Int                     # atom index in home cell (1..N)
    j::Int                     # atom index in cell displaced by R
    R::SVector{3,Int}          # lattice offset (in integer supercell coordinates)
    r0::SVector{3,Float64}     # equilibrium cartesian bond vector from i@0 to j@R (Å)
    kL::T                      # longitudinal spring (eV/Å^2 by convention)
    kT::T                      # transverse spring   (eV/Å^2 by convention)
end

mutable struct Model{T}
    lattice::SMatrix{3,3,Float64,9}         # columns = a1 a2 a3 (Å)
    fracpos::Vector{SVector{3,Float64}}     # fractional positions in [0,1)
    species::Vector{Symbol}                 # species labels
    mass::Vector{T}                         # length N, mass units (amu or kg; see DSF kwarg)
    bonds::Vector{Bond{T}}                  # pair list with (kL,kT)
    N::Int
end



#Add FCM (3x3) Block Matrix
@inline function _add_block!(Φ::Dict{Tuple{Int,Int,SVector{3,Int}}, SMatrix{3,3,Float64,9}},
                             key::Tuple{Int,Int,SVector{3,Int}}, M::SMatrix{3,3,Float64,9})
    Φ[key] = get(Φ, key, zeros(SMatrix{3,3,Float64,9})) + M
    return nothing
end


# Convenience
mass_vector(m::Model) = m.mass

#---------#
# Helpers #
#---------#

#Convert fractional to cartesian coordinates
@inline frac_to_cart(L::SMatrix{3,3,Float64,9}, f::SVector{3,Float64}) = L * f

# Access Sunny module lazily (optional dependency)
@inline function _sunny_mod()
    isdefined(Main, :Sunny) || error("Sunny.jl must be loaded to use this feature")
    return getfield(Main, :Sunny)
end



#---------------------------------------#
# Physical Constants ~ meV and Angstrom # Check these for consistency.
#---------------------------------------#

const ℏ = 1.054571817e-34 # J·s
const kB = 1.380649e-23   # J/K

# Unit conversions
const eV_to_J      = 1.602176634e-19   #1 eV  = 1.6e-19 J
const meV_to_J     = 1.602176634e-22   #1 meV = 1.6e-22 J
const u_to_kg      = 1.66053906660e-27 #1 amu = 1.6e-27 kg
const N_per_m_per_eVA2 = 16.02176634   #1 eV/Å^2 = 16.02176634 N/m
# If Φ built with k in eV/Å^2 and masses in u:
#   ω_int = sqrt( eV/Å^2 / u ),  E_meV = α * ω_int  with  α = ħ sqrt(N_per_m_per_eVA2/u_to_kg) / meV_to_J
const ALPHA_meV    = 64.65415130134122

#---meV–Å–amu convenience constants---#
const HBAR_meV_ps        = 0.6582119514       # meV·ps
const K_B_meV_per_K      = 0.08617333262145   # meV/K
const AMU_Aps2_to_meV    = 0.103642691        # 1 amu·(Å/ps)^2 = 0.103642691 meV
const MSD_PREF_A2        = (HBAR_meV_ps^2) / (2*AMU_Aps2_to_meV)#((ℏ^2)*N_per_m_per_eVA2) / (2 * u_to_kg * meV_to_J) # amu·Å^2·meV




#--------------------------------#
# Element/isotope data & lookups #
#--------------------------------#

# Natural-abundance atomic masses (amu) [Source: Pub Chem]
const MASS_U = Dict{Symbol,Float64}(
    :H => 1.00794, :He => 4.002602, :Li => 7.0, :Be => 9.012183, :B => 10.81, :C => 12.011, 
    :N => 14.0067, :O => 15.999, :F => 18.998403163, :Ne => 20.1797, :Na => 22.98976928, 
    :Mg => 24.305, :Al => 26.9815385, :Si => 28.085, :P => 30.973761998, :S => 32.06, 
    :Cl => 35.45, :Ar => 39.948, :K => 39.0983, :Ca => 40.078, :Sc => 44.9559, :Ti => 47.867, 
    :V => 50.9415, :Cr => 51.9961, :Mn => 54.938044, :Fe => 55.845, :Co => 58.933194, 
    :Ni => 58.6934, :Cu => 63.546, :Zn => 65.38, :Ga => 69.723, :Ge => 72.630, :As => 74.921595, 
    :Se => 78.971, :Br => 79.9, :Kr => 83.8, :Rb => 85.468, :Sr => 87.62, :Y => 88.90584,
    :Zr => 91.22, :Nb => 92.90637, :Mo => 95.95, :Tc => 96.90636, :Ru => 101.1, :Rh => 102.9055,
    :Pd => 106.42, :Ag => 107.868, :Cd => 112.41, :In => 114.818, :Sn => 118.71, :Sb => 121.76,
    :Te => 127.6, :I => 126.9045, :Xe => 131.29, :Cs => 132.90452, :Ba => 137.33, :La => 138.9055,
    :Ce => 140.116, :Pr => 140.90766, :Nd => 144.24, :Pm => 144.91276, :Sm => 150.4, :Eu => 151.964,
    :Gd => 157.25, :Tb => 158.92535, :Dy => 162.5, :Ho => 164.93033, :Er => 167.26, :Tm => 168.93422,
    :Yb => 173.05, :Lu => 174.9667, :Hf => 178.49, :Ta => 180.9479, :W => 183.84, :Re => 186.207, 
    :Os => 190.2, :Ir => 192.22, :Pt => 195.08, :Au => 196.96657, :Hg => 200.59, :Tl => 204.383, 
    :Pb => 207.0, :Bi => 208.9804, :Po => 208.98243, :At => 209.98715, :Rn => 222.01758, :Fr => 223.01973, 
    :Ra => 226.02541, :Ac => 227.02775, :Th => 232.038, :Pa => 231.03588, :U => 238.0289, :Np => 237.048172,
    :Pu => 244.0642, :Am => 243.06138, :Cm => 247.07035, :Bk => 247.07035, :Cf => 251.07959, :Es => 252.083,
    :Fm => 257.09511, :Md => 258.09843, :No => 259.101, :Lr => 266.12, :Rf => 267.122, :Db => 268.126, 
    :Sg => 269.128, :Bh => 270.133, :Hs => 269.1336, :Mt => 277.154, :Ds => 282.166, :Rg => 282.169, 
    :Cn => 286.179, :Nh => 286.182, :Fl => 290.196, :Mc => 290.196, :Lv => 293.205, :Ts => 294.211, 
    :Og => 295.216,
)

# Isotopic masses (amu) for common isotopes used in tests/examples.
const MASS_ISO_U = Dict{Tuple{Symbol,Int},Float64}(
    (:H,1)=>1.00782503223, (:H,2)=>2.01410177812, (:H,3)=>3.01604928199,
    (:C,12)=>12.0, (:C,13)=>13.00335483507,
    (:N,14)=>14.00307400443, (:N,15)=>15.00010889888,
    (:O,16)=>15.99491461957, (:O,17)=>16.99913175650, (:O,18)=>17.99915961286,
    (:Si,28)=>27.97692653465, (:Si,29)=>28.97649466490, (:Si,30)=>29.973770136,
    (:Cu,63)=>62.929597474, (:Cu,65)=>64.92778970,
    (:Fe,54)=>53.93960899, (:Fe,56)=>55.93493633, (:Fe,57)=>56.93539284, (:Fe,58)=>57.93327443,
)

# Neutron coherent scattering lengths (fm): natural abundance (approx) [Source: NIST]
const BCOH_FM = Dict{Symbol,Float64}(
    :H => -3.7390, :D => 6.671, :He => 3.26, :Li => -1.9, :Be => 7.79, :B => 5.3, :C => 6.6460, 
    :N => 9.36, :O => 5.803, :F => 5.654, :Ne => 4.566, :Na => 3.63, :Mg => 5.375, :Al => 3.449,
    :Si => 4.1491, :P => 5.13, :S => 2.847, :Cl => 9.577, :Ar => 1.909, :K => 3.67, :Ca => 4.7,
    :Sc => 12.29, :Ti => -3.428, :V => -0.3824, :Cr => 3.635, :Mn => -3.73, :Fe => 9.45, :Co => 2.49,
    :Ni => 10.3, :Cu => 7.718, :Zn => 5.68, :Ga => 7.288, :Ge => 8.185, :As => 6.58, :Se => 7.97,
    :Br => 6.795, :Kr => 7.81, :Rb => 7.09, :Sr => 7.02, :Y => 7.75, :Zr => 7.16, :Nb => 7.054,
    :Mo => 6.715, :Tc => 6.8, :Ru => 7.03, :Rh => 5.88, :Pd => 5.91, :Ag => 5.922, :Cd => 4.87,
    :In => 4.065, :Sn => 6.225, :Sb => 5.57, :Te => 5.8, :I => 5.28, :Xe => 4.92, :Cs => 5.42,
    :Ba => 5.07, :La => 8.24, :Ce => 4.84, :Pr => 4.58, :Nd => 7.69, :Pm => 12.6, :Sm => 0.8,
    :Eu => 7.22, :Gd => 6.5, :Tb => 7.28, :Dy => 16.9, :Ho => 8.01,
    :Er => 7.79, :Tm => 7.07, :Yb => 12.43, :Lu => 7.21, :Hf => 7.7, :Ta => 6.91, :W => 4.86, :Re => 9.2,
    :Os => 10.7, :Ir => 10.6, :Pt => 9.6, :Au => 7.63, :Hg => 12.692, :Tl => 8.776, :Pb => 9.405, :Bi => 8.532,
    :Ra => 10.0, :Th => 10.31, :Pa => 9.1, :U => 8.417, :Np => 10.55, :Am => 8.3,
)

# Isotopic coherent lengths (fm) (limited subset for examples)
const BCOH_ISO_FM = Dict{Tuple{Symbol,Int},Float64}(
    (:H,1) => -3.7390, (:H,2) => 6.671,  (:H,3) => 4.792, # Hydrogen, Deuterium, Tritium
    (:He, 3) => 5.740, (:He, 4) => 3.26,
    (:Li, 6) => 2.000, (:Li, 7) => -2.22,
    (:B, 10) => -0.10, (:B, 11) => 6.65,
    (:C, 12) => 6.6511,(:C, 13) => 6.19,
    (:N, 14) => 9.370, (:N, 15) => 6.44,
    (:O, 16) => 5.803, (:O, 17) => 5.78, (:O, 18) => 5.841,
    (:Ne,20) => 4.631, (:Ne,21) => 6.66, (:Ne,22) => 3.87,
    (:Mg,24) => 5.660, (:Mg,25) => 3.62, (:Mg,26) => 4.89,
    (:Si,28) => 4.106, (:Si,29) => 4.70, (:Si,30) => 6.50,
    (:S, 32) => 2.804, (:S, 33) => 4.74, (:S, 34) => 3.48, (:S, 36) => 3.0,
    (:Cl,35) => 11.65, (:Cl,37) => 3.08,
    (:Ar,36) => 24.90, (:Ar,38) => 3.50, (:Ar,40) => 1.83,
    (:K, 39) => 3.740, (:K, 40) => 3.00, (:K, 41) => 2.69,
    (:Ca,40) => 4.800, (:Ca,42) => 3.36, (:Ca,43) => -1.56, (:Ca,44) => 1.42, (:Ca,46) => 3.6, (:Ca,48) => 0.39,
    (:Ti,46) => 4.930, (:Ti,47) => 3.63, (:Ti,48) => -6.08, (:Ti,49) => 1.05, (:Ti,50) => 6.18,
    (:V, 50) => 7.600, (:V, 51) => -0.402,
    (:Cr,50) => -4.50, (:Cr,52) => 4.92, (:Cr,53) => -4.20, (:Cr,54) => 4.55,
    (:Fe,54) => 4.200, (:Fe,56) => 9.94, (:Fe,57) => 2.200, (:Fe,58) => 15.0,
    (:Ni,58) => 14.40, (:Ni,60) => 2.80, (:Ni,61) => 7.600, (:Ni,62) => -8.7, (:Ni,64) => -0.37,
    (:Cu,63) => 6.430, (:Cu,65) => 10.61,
    (:Zn,64) => 5.220, (:Zn,66) => 5.97, (:Zn,67) => 7.56, (:Zn,68) => 6.03, (:Zn,70) => 6.0,
    (:Ga,69) => 7.880, (:Ga,71) => 6.40,
    (:Ge,70) => 10.00, (:Ge,72) => 8.51, (:Ge,73) => 5.02, (:Ge,74) => 7.58, (:Ge,76) => 8.2,
    (:Se,74) => 0.800, (:Se,76) => 12.2, (:Se,77) => 8.25, (:Se,78) => 8.24, (:Se,80) => 7.48, (:Se,82) => 6.34,
    (:Br,79) => 6.800, (:Br,81) => 6.79,
    (:Kr,86) => 8.1,
    (:Rb,85) => 7.030, (:Rb,87) => 7.23,
    (:Sr,84) => 7.000, (:Sr,86) => 5.67, (:Sr,87) => 7.40, (:Sr,88) => 7.15,
    (:Zr,90) => 6.400, (:Zr,91) => 8.70, (:Zr,92) => 7.40, (:Zr,94) => 8.20, (:Zr,96) => 5.5,
    (:Mo,92) => 6.910, (:Mo,94) => 6.80, (:Mo,95) => 6.91, (:Mo,96) => 6.20, (:Mo,97) => 7.24, (:Mo,98) => 6.58, (:Mo,100) => 6.73,
    (:Pd,102)=> 7.700, (:Pd,104)=> 7.70, (:Pd,105)=> 5.50, (:Pd,106)=> 6.40, (:Pd,108)=> 4.10, (:Pd,110)=> 7.70,
    (:Ag,107)=> 7.555, (:Ag,109)=> 4.165,
    (:Cd,106)=> 5.000, (:Cd,108)=> 5.40, (:Cd,110)=> 5.90, (:Cd,111)=> 6.50, (:Cd,112)=> 6.40, (:Cd,113)=> -8.0, (:Cd,114)=> 7.5, (:Cd,116)=> 6.3,
    (:In,113)=> 5.390, (:In,115)=> 4.01,
    (:Sn,112)=> 6.000, (:Sn,114)=> 6.20, (:Sn,115)=> 6.00, (:Sn,116)=> 5.93, (:Sn,117)=> 6.48, (:Sn,118)=> 6.07, (:Sn,119)=> 6.12, (:Sn,120)=> 6.49, (:Sn,122)=> 5.74, (:Sn,124)=> 5.97,
    (:Sb,121)=> 5.710, (:Sb,123)=> 5.38,
    (:Te,120)=> 5.300, (:Te,122)=> 3.80, (:Te,123)=> -0.05, (:Te,124)=> 7.96, (:Te,125)=> 5.02, (:Te,126)=> 5.56, (:Te,128)=> 5.89, (:Te,130)=> 6.02,
    (:Ba,130)=> -3.60, (:Ba,132)=> 7.80, (:Ba,134)=> 5.70, (:Ba,135)=> 4.67, (:Ba,136)=> 4.91, (:Ba,137)=> 6.83, (:Ba,138)=> 4.84,
    (:La,138)=> 8.000, (:La,139)=> 8.24,
    (:Ce,136)=> 5.800, (:Ce,138)=> 6.70, (:Ce,140)=> 4.84, (:Ce,142)=> 4.75,
    (:Nd,142)=> 7.700, (:Nd,143)=> 14.0, (:Nd,144)=> 2.80, (:Nd,145)=> 14.0, (:Nd,146)=> 8.7, (:Nd,148)=> 5.7, (:Nd,150)=> 5.3,
    (:Sm,144)=> -3.00, (:Sm,147)=> 14.0, (:Sm,148)=> -3.0, (:Sm,149)=> -19.2, (:Sm,150)=> 14.0, (:Sm,152)=> -5.0, (:Sm,154)=> 9.3,
    (:Eu,151)=> 6.13, (:Eu,153)=> 8.22,
    (:Gd,152)=> 10.00, (:Gd,154)=> 10.0, (:Gd,155)=> 6.0, (:Gd,156)=> 6.3, (:Gd,157)=> -1.14, (:Gd,158)=> 9.0, (:Gd,160)=> 9.15,
    (:Dy,156)=> 6.100, (:Dy,158)=> 6.00, (:Dy,160)=> 6.70, (:Dy,161)=> 10.3, (:Dy,162)=> -1.4, (:Dy,163)=> 5.0, (:Dy,164)=> 49.4,
    (:Er,162)=> 8.800, (:Er,164)=> 8.20, (:Er,166)=> 10.6, (:Er,167)=> 3.00, (:Er,168)=> 7.40, (:Er,170)=> 9.6,
    (:Yb,168)=> -4.07, (:Yb,170)=> 6.77, (:Yb,171)=> 9.66, (:Yb,172)=> 9.43, (:Yb,173)=> 9.56, (:Yb,174)=> 19.3, (:Yb,176)=> 8.72,
    (:Lu,175)=> 7.240, (:Lu,176)=> 6.1,
    (:Hf,174)=> 10.90, (:Hf,176)=> 6.61, (:Hf,177)=> 0.80, (:Hf,178)=> 5.90, (:Hf,179)=> 7.46, (:Hf,180)=> 13.2,
    (:Ta,180)=> 7.000, (:Ta,181)=> 6.91,
    (:W, 180)=> 5.000, (:W, 182)=> 6.97, (:W, 183)=> 6.53, (:W, 184)=> 7.48, (:W, 186)=> -0.72, 
    (:Re,185)=> 9.000, (:Re,187)=> 9.30,
    (:Os,184)=> 10.00, (:Os,186)=> 11.6, (:Os,187)=> 10.0, (:Os,188)=> 7.60, (:Os,189)=> 10.7, (:Os,190)=> 11.0, (:Os,192)=> 11.5,
    (:Ir,191)=> 37.30, (:Ir,193)=> 62.7,
    (:Pt,190)=> 9.000, (:Pt,192)=> 9.90, (:Pt,194)=> 10.55, (:Pt,195)=> 8.83, (:Pt,196)=> 9.89, (:Pt,198)=> 7.8,
    (:Hg,196)=> 30.30, (:Hg,199)=> 16.9,
    (:Tl,203)=> 6.990, (:Tl,205)=> 9.52,
    (:Pb,204)=> 9.900, (:Pb,206)=> 9.22, (:Pb,207)=> 9.28, (:Pb,208)=> 9.5,
    (:U, 233)=> 10.10, (:U, 234)=> 12.4, (:U, 235)=> 10.47, (:U,238)=> 8.402,
    (:Pu,238)=> 14.10, (:Pu,239)=> 7.70, (:Pu,240)=> 3.50, (:Pu,242)=> 8.1,
    (:Cm,244)=> 9.500, (:Cm,246)=> 9.30, (:Cm,248)=> 7.70,  
)





















